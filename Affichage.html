<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <title>Grist Two-Step Selection with Editable Table</title>
  <script src="https://docs.getgrist.com/grist-plugin-api.js"></script>
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
      background-color: #2c2c2c;
      color: white;
    }

    .sticky-container {
      position: sticky;
      top: 0;
      background-color: #2c2c2c;
      padding: 20px;
      display: flex;
      align-items: flex-start;
      z-index: 1000;
      box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1);
    }

    .dropdown-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-right: 20px;
    }

    label {
      font-weight: bold;
      margin-bottom: 10px;
    }

    select {
      width: 200px;
      padding: 8px;
      margin-bottom: 20px;
    }

    table {
      width: 100%;
      max-width: 800px;
      border-collapse: collapse;
      margin-top: 20px;
      background-color: #fff;
    }

    th,
    td {
      padding: 10px;
      border: 1px solid #ddd;
      text-align: left;
    }

    th {
      background-color: #333;
      color: white;
    }

    td {
      color: black;
    }

    .table-container {
      margin-top: 20px;
      padding: 20px;
    }

    .add-form {
      margin-top: 20px;
      padding: 10px;
      background-color: #f4f4f4;
      color: black;
    }

    .add-form input {
      margin-right: 10px;
      padding: 5px;
    }

    .add-form button {
      padding: 5px 10px;
      cursor: pointer;
    }

    /* Context Menu Styles */
    .context-menu {
      display: none;
      position: absolute;
      background-color: #333;
      color: white;
      border: 1px solid #ddd;
      z-index: 10000;
      padding: 10px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
    }

    /* Dialog Styles */
    dialog {
      width: 400px;
      padding: 20px;
      background-color: #2c2c2c;
      color: white;
      border: 1px solid #444;
      border-radius: 5px;
    }

    dialog h3 {
      margin-top: 0;
    }

    dialog label {
      display: block;
      margin: 10px 0 5px;
    }

    dialog input,
    dialog textarea {
      width: 100%;
      padding: 8px;
      margin-bottom: 10px;
      background-color: #444;
      border: 1px solid #666;
      color: white;
    }

    dialog textarea {
      height: 100px;
      resize: vertical;
    }

    .dialog-buttons {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-top: 20px;
    }

    dialog button {
      padding: 8px 16px;
      background-color: #666;
      border: none;
      color: white;
      cursor: pointer;
    }

    dialog button[type="submit"] {
      background-color: #4CAF50;
    }

    dialog button[type="button"] {
      background-color: #666;
    }

    dialog button:hover {
      opacity: 0.9;
    }

    .context-menu button {
      display: block;
      background: none;
      border: none;
      color: white;
      cursor: pointer;
      padding: 5px;
      width: 100%;
      text-align: left;
    }

    .context-menu button:hover {
      background-color: #444;
    }
  </style>
</head>

<body>
  <!-- Container for the sticky selection lists -->
  <div class="sticky-container">
    <!-- First dropdown for selecting a project -->
    <div class="dropdown-container">
      <label for="firstColumnDropdown">Projet :</label>
      <select id="firstColumnDropdown">
        <option value="">Choix projet</option>
      </select>
    </div>

    <!-- Second dropdown for selecting the tableau -->
    <div class="dropdown-container">
      <label for="secondColumnListbox">Etage :</label>
      <select id="secondColumnListbox">
        <option value="">Choix étage</option>
      </select>
    </div>
  </div>

  <!-- Table to display and edit the data -->
  <div class="table-container">
    <table id="dataTable">
      <thead>
        <tr id="tableHeader">
          <th>ID</th> <!-- Add a column for ID -->
        </tr>
      </thead>
      <tbody id="tableBody"></tbody>
    </table>
  </div>

  <!-- Context Menu -->
  <div id="contextMenu" class="context-menu">
    <button id="addRowOption">Ajouter une ligne</button>
    <button id="editOption">Modifier</button>
    <button id="archiveOption">Archiver</button>
    <button id="deleteOption">Supprimer</button>
  </div>

  <!-- Add Row Dialog -->
  <dialog id="addRowDialog">
    <form method="dialog">
      <h3>Ajouter une nouvelle ligne</h3>

      <label for="emetteur">Emetteur:</label>
      <input type="text" id="emetteur" name="emetteur" required>

      <label for="reference">Reference:</label>
      <div style="display: flex; gap: 10px;">
        <input type="text" id="reference" name="reference" required style="flex: 1;">
        <input type="file" id="referenceFile" style="display: none;" accept="*.*">
        <button type="button" onclick="document.getElementById('referenceFile').click()"
          style="padding: 0px 5px;">Select File</button>
      </div>
      <script>
        document.getElementById('referenceFile').addEventListener('change', function () {
          if (this.files.length > 0) {
            document.getElementById('reference').value = this.files[0].name;
          }
        });
      </script>

      <label for="indice">Indice:</label>
      <input type="text" id="indice" name="indice" required>

      <label for="recu">Recu:</label>
      <input type="date" id="recu" name="recu" required>

      <label for="description">Description:</label>
      <textarea id="description" name="description" required></textarea>

      <label for="datelimite">Date Limite:</label>
      <input type="date" id="datelimite" name="datelimite" required>

      <div class="dialog-buttons">
        <button type="submit">Ajouter</button>
        <button type="button" onclick="document.getElementById('addRowDialog').close()">Annuler</button>
      </div>
    </form>
  </dialog>
  <!-- Add Etage Dialog -->
  <dialog id="addEtageDialog">
    <form method="dialog">
      <h3>Ajouter un nouvel étage</h3>

      <label for="etageName">Nom de l'étage:</label>
      <input type="text" id="etageName" name="etageName" required>

      <label for="defaultDatelimite">Date Limite réception données par défaut:</label>
      <input type="date" id="defaultDatelimite" name="defaultDatelimite" required>

      <div class="dialog-buttons">
        <button type="submit">Ajouter</button>
        <button type="button" onclick="document.getElementById('addEtageDialog').close()">Annuler</button>
      </div>
    </form>
  </dialog>

  <!-- Add Project Dialog -->
  <dialog id="addProjectDialog">
    <form method="dialog">
      <h3>Ajouter un nouveau projet</h3>

      <label for="projectName">Nom du projet:</label>
      <input type="text" id="projectName" name="projectName" required>

      <div class="dialog-buttons">
        <button type="submit">Ajouter</button>
        <button type="button" onclick="document.getElementById('addProjectDialog').close()">Annuler</button>
      </div>
    </form>
  </dialog>

  <!-- Edit Row Dialog -->
  <dialog id="editRowDialog">
    <form method="dialog">
      <h3>Modifier la ligne</h3>

      <label for="editEmetteur">Emetteur:</label>
      <input type="text" id="editEmetteur" name="emetteur" required>

      <label for="editReference">Reference:</label>
      <div style="display: flex; gap: 10px;">
        <input type="text" id="editReference" name="reference" required style="flex: 1;">
        <input type="file" id="editReferenceFile" style="display: none;" accept="*.*">
        <button type="button" onclick="document.getElementById('editReferenceFile').click()"
          style="padding: 0px 5px;">Select File</button>
      </div>

      <label for="editIndice">Indice:</label>
      <input type="text" id="editIndice" name="indice" required>

      <label for="editRecu">Recu:</label>
      <input type="date" id="editRecu" name="recu" required>

      <label for="editDescription">Description:</label>
      <textarea id="editDescription" name="description" required></textarea>

      <label for="editDatelimite">Date Limite:</label>
      <input type="date" id="editDatelimite" name="datelimite" required>

      <div class="dialog-buttons">
        <button type="submit">Enregistrer</button>
        <button type="button" onclick="document.getElementById('editRowDialog').close()">Annuler</button>
      </div>
    </form>
  </dialog>

  <!-- Form to add new rows -->
  <div class="add-form">
    <button id="addProjectButton">Ajouter projet</button>

    <input type="file" id="fileInput" style="display: none;" multiple>
  </div>

  <script>
    // window.alert = function () {
    //   debugger;
    // }
    let records = [];
    let selectedFirstValue = '';
    let selectedSecondValue = '';
    let currentEmetteur = '';
    let selectedRecordId = null;
    let newTable = false; // Variable to track if a new table is being added
    let newTableName = ''; // Variable to store the name of the new table

    // Ready Grist
    grist.ready();

    // Fonction pour peupler la première liste déroulante avec des valeurs uniques de la première colonne
    function populateFirstColumnDropdown(values) {
      const dropdown = document.getElementById('firstColumnDropdown');

      // Conserve la sélection actuelle
      const currentSelection = dropdown.value;

      dropdown.innerHTML = '<option value="">Select an option</option>'; // Réinitialise la liste déroulante

      values.forEach(value => {
        if (value) {  // Ignore les valeurs nulles ou vides
          const option = document.createElement('option');
          option.value = value;
          option.text = value;
          dropdown.appendChild(option);
        }
      });

      // Restaure la sélection précédente si elle est encore présente dans les options
      dropdown.value = currentSelection || ''; // Conserve l'option sélectionnée ou reste sur "Select an option"
    }

    // Écouteur d'événement pour mettre à jour la valeur sélectionnée dans la première liste
    document.getElementById('firstColumnDropdown').addEventListener('change', function () {
      selectedFirstValue = this.value;
      if (selectedFirstValue) {
        populateSecondColumnListbox(selectedFirstValue);
      } else {
        document.getElementById('secondColumnListbox').innerHTML = '';  // Efface la seconde liste si aucune sélection
      }
    });

    // Function to populate the second dropdown based on the selected first column value
    function populateSecondColumnListbox(selectedValue) {
      const listbox = document.getElementById('secondColumnListbox');
      listbox.innerHTML = '<option value="">Select an option</option>'; // Réinitialise la liste

      const secondColumnValues = records
        .filter(record => record.NomProjet === selectedValue) // Filtre selon le projet
        .map(record => record.NomEtage) // Extrait les valeurs
        .filter((value, index, self) => value && self.indexOf(value) === index) // Supprime les doublons
        .sort();

      secondColumnValues.forEach(value => {
        const option = document.createElement('option');
        option.value = value;
        option.text = value;
        listbox.appendChild(option);
      });

      // Ajoute l'option "Ajouter étage"
      const addOption = document.createElement('option');
      addOption.value = 'addTable';
      addOption.text = 'Ajouter étage';
      listbox.appendChild(addOption);
    }

    // Helper function to check if a string is a valid date
    function isValidDate(dateString) {
      const date = new Date(dateString);
      return date instanceof Date && !isNaN(date);
    }

    // Helper function to format date as DD/MM/YYYY
    function formatDate(dateString) {
      const date = new Date(dateString);
      const day = String(date.getDate()).padStart(2, '0');
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const year = date.getFullYear();
      return `${day}/${month}/${year}`;
    }

    // Function to populate the table based on the selected first and second column values
    function populateTable() {
      const selections = getCurrentSelections();
      if (!selections) return;

      const { selectedProject, selectedTable } = selections;
      const tableBody = document.getElementById('tableBody');
      const tableHeader = document.getElementById('tableHeader');

      tableBody.innerHTML = '';
      const filteredRecords = records.filter(
        (record) =>
          record.NomProjet === selectedProject && record.NomEtage === selectedTable
      );

      if (filteredRecords.length === 0) return;

      const headers = Object.keys(filteredRecords[0]).filter(
        (key) => key !== 'NomProjet' && key !== 'NomEtage' && key !== 'id'
      );

      tableHeader.innerHTML = '<th>ID</th>';
      headers.forEach((header) => {
        const th = document.createElement('th');
        th.textContent = header;
        tableHeader.appendChild(th);
      });

      filteredRecords.sort((a, b) => {
        const emetteurA = a.Emetteur || '';
        const emetteurB = b.Emetteur || '';
        return emetteurA.localeCompare(emetteurB);
      });

      filteredRecords.forEach((record) => {
        const tr = document.createElement('tr');
        tr.addEventListener('contextmenu', (event) => {
          currentEmetteur = record.Emetteur;
          showContextMenu(event, record.id);
        });

        const idCell = document.createElement('td');
        idCell.textContent = record.id;
        tr.appendChild(idCell);

        headers.forEach((header) => {
          const td = document.createElement('td');
          td.contentEditable = true;
          let value = record[header] || '';

          // Format date fields (Recu and DateLimite)
          if ((header === 'Recu' || header === 'DateLimite') && isValidDate(value)) {
            value = formatDate(value);
          }

          td.textContent = value;
          tr.appendChild(td);
        });

        tableBody.appendChild(tr);
      });
      formatTable();
    }

    function formatTable() {
      const tableBody = document.getElementById('tableBody');
      const rows = tableBody.rows;
      let previousText = null;
      let rowspanCount = 1;

      for (let i = 0; i < rows.length; i++) {
        const currentCell = rows[i].cells[1]; // Second column

        if (currentCell.innerText === previousText) {
          // Increase rowspan count and hide current cell
          rows[i - rowspanCount].cells[1].rowSpan = rowspanCount + 1; // Update rowspan
          currentCell.style.display = "none"; // Hide current cell
          rowspanCount++;
        } else {
          // Reset rowspan count
          previousText = currentCell.innerText;
          rowspanCount = 1;
        }
      }
    }

    // Show edit dialog with row data
    function showEditDialog(record) {
      const dialog = document.getElementById('editRowDialog');

      // Populate form fields with record data
      document.getElementById('editEmetteur').value = record.Emetteur || '';
      document.getElementById('editReference').value = record.Reference || '';
      document.getElementById('editIndice').value = record.Indice || '';
      document.getElementById('editRecu').value = record.Recu ? record.Recu.split('T')[0] : '';
      document.getElementById('editDescription').value = record.DescriptionObservations || '';
      document.getElementById('editDatelimite').value = record.DateLimite?.toLocaleDateString() || '';

      selectedRecordId = record.id;
      dialog.showModal();
    }

    // Show context menu on right-click and get the record ID from the first column
    function showContextMenu(event, recordId) {
      event.preventDefault();
      selectedRecordId = recordId;  // Store the ID of the selected record

      const contextMenu = document.getElementById('contextMenu');
      contextMenu.style.display = 'block';
      contextMenu.style.left = `${event.pageX}px`;
      contextMenu.style.top = `${event.pageY}px`;
    }

    // Hide context menu if clicked elsewhere
    document.addEventListener('click', function (event) {
      const contextMenu = document.getElementById('contextMenu');
      if (!contextMenu.contains(event.target)) {
        contextMenu.style.display = 'none';
      }
    });

    // Add event listener for "Ajouter une ligne" option
    document.getElementById('addRowOption').addEventListener('click', () => {
      const dialog = document.getElementById('addRowDialog');
      if (currentEmetteur) {
        dialog.querySelector('#emetteur').value = currentEmetteur;
      }
      dialog.showModal();
      hideContextMenu();
    });

    // Add event listener for "Modifier" option
    document.getElementById('editOption').addEventListener('click', () => {
      if (selectedRecordId) {
        const record = records.find(rec => rec.id === selectedRecordId);
        if (record) {
          showEditDialog(record);
        }
      }
      hideContextMenu();
    });

    // Handle dialog form submission
    document.getElementById('addRowDialog').addEventListener('submit', (e) => {
      e.preventDefault();

      const formData = new FormData(e.target);
      const emetteur = formData.get('emetteur');
      const reference = formData.get('reference');
      const indice = formData.get('indice');
      const recu = formData.get('recu');
      const description = formData.get('description');
      const datelimite = formData.get('datelimite');

      if (selectedRecordId) {
        const newRow = {
          NomProjet: selectedFirstValue,
          NomEtage: selectedSecondValue,
          Emetteur: emetteur,
          Reference: reference,
          Indice: indice,
          Recu: recu,
          DescriptionObservations: description,
          DateLimite: datelimite
        };

        grist.docApi.applyUserActions([
          ['AddRecord', 'References', null, newRow]
        ])
          .then(result => {
            const newRowId = result.retValues[0];
            console.log('New Row ID:', newRowId);
            document.getElementById('addRowDialog').close();
            populateTable();
          })
          .catch(error => {
            console.error("Error inserting row:", error);
            alert("Error inserting row.");
          });
      }
    });

    // Handle edit dialog form submission
    document.getElementById('editRowDialog').addEventListener('submit', (e) => {
      e.preventDefault();

      const formData = new FormData(e.target);
      const updatedRow = {
        Emetteur: formData.get('emetteur'),
        Reference: formData.get('reference'),
        Indice: formData.get('indice'),
        Recu: formData.get('recu'),
        DescriptionObservations: formData.get('description'),
        DateLimite: formData.get('datelimite')
      };

      // Handle file upload if a file was selected
      const fileInput = document.getElementById('editReferenceFile');
      if (fileInput.files.length > 0) {
        const file = fileInput.files[0];
        updatedRow.Reference = file.name;
      }

      if (selectedRecordId) {
        grist.docApi.applyUserActions([
          ['UpdateRecord', 'References', selectedRecordId, updatedRow]
        ])
          .then(() => {
            console.log('Row updated successfully');
            document.getElementById('editRowDialog').close();
            populateTable();
          })
          .catch(error => {
            console.error("Error updating row:", error);
            alert("Error updating row.");
          });
      }
    });

    // Add event listener for "Supprimer" option
    document.getElementById('deleteOption').addEventListener('click', () => {
      if (selectedRecordId) {
        if (confirm("Êtes-vous sûr de vouloir supprimer cette ligne ?")) {
          grist.docApi.applyUserActions([
            ['RemoveRecord', 'References', selectedRecordId]
          ])
            .then(() => {
              console.log('Row deleted successfully');
              populateTable();
              hideContextMenu();
            })
            .catch(error => {
              console.error("Error deleting row:", error);
              alert("Error deleting row.");
            });
        }
      }
    });

    // Handle file selection in edit dialog
    document.getElementById('editReferenceFile').addEventListener('change', function () {
      if (this.files.length > 0) {
        document.getElementById('editReference').value = this.files[0].name;
      }
    });
    // Add event listener for "Archiver" option
    document.getElementById('archiveOption').addEventListener('click', () => {
      if (selectedRecordId) {
        if (confirm("Êtes-vous sûr de vouloir archiver cette ligne ?")) {
          grist.docApi.applyUserActions([
            ['UpdateRecord', 'References', selectedRecordId, { Archive: true }]
          ])
            .then(() => {
              console.log('Row archived successfully');
              populateTable();
              hideContextMenu();
            })
            .catch(error => {
              console.error("Error archiving row:", error);
              alert("Error archiving row.");
            });
        }
      }
    });
    // Add event listener for "Supprimer" option
    document.getElementById('deleteOption').addEventListener('click', () => {
      console.log("Supprimer clicked for row ID:", selectedRecordId);

      // Supprime la ligne dans Grist
      grist.docApi.applyUserActions([['RemoveRecord', 'References', Number(selectedRecordId)]])
        .then(() => {
          // Supprime la ligne localement dans le tableau
          records = records.filter(record => record.ID_Ligne !== selectedRecordId);

          // Actualise l'affichage du tableau
          populateTable();

          // Masquer le menu contextuel après la suppression
          hideContextMenu();

          console.log("Tableau actualisé et menu contextuel masqué après suppression.");
        })
        .catch(error => {
          console.error("Erreur lors de la suppression de la ligne dans Grist:", error);
          alert("Une erreur s'est produite lors de la suppression de la ligne.");
        });
    });

    // Fonction pour cacher le menu contextuel
    function hideContextMenu() {
      const contextMenu = document.getElementById('contextMenu');
      contextMenu.style.display = 'none';
    }

    // Fetch records from Grist
    grist.onRecords(function (receivedRecords) {
      console.log("Records received from Grist:", receivedRecords);

      records = receivedRecords;

      if (newTable) {
        newTable = false; // Reset the flag after handling the new table
        populateSecondColumnListbox(selectedFirstValue);

        // Sélectionne automatiquement le nouveau tableau
        const listbox = document.getElementById('secondColumnListbox');
        listbox.value = newTableName;

        // Déclenche l'affichage du tableau correspondant
        selectedSecondValue = newTableName;
        populateTable();
      } else {
        populateTable()
        // Populate the first dropdown with unique values from 'NomProjet'
        const uniqueFirstColumnValues = [...new Set(records.map(record => record.NomProjet))];
        populateFirstColumnDropdown(uniqueFirstColumnValues);
      }
    });

    // Listen to changes in the first dropdown and update the second listbox accordingly
    document.getElementById('firstColumnDropdown').addEventListener('change', function () {
      selectedFirstValue = this.value;
      if (selectedFirstValue) {
        populateSecondColumnListbox(selectedFirstValue);
      } else {
        document.getElementById('secondColumnListbox').innerHTML = '';  // Clear second listbox if no selection
      }
    });

    // Listen to changes in the second dropdown and update the table accordingly
    document.getElementById('secondColumnListbox').addEventListener('change', function () {
      const selectedValue = this.value;

      // Gérer l'ajout d'un tableau
      if (selectedValue === 'addTable') {
        handleAddTable();
        return;
      }

      // Gestion normale de la sélection
      selectedSecondValue = selectedValue;
      if (selectedFirstValue && selectedSecondValue) {
        populateTable();
      }
    });

    // Fonction pour gérer l'ajout d'un tableau
    function handleAddTable() {
      const dialog = document.getElementById('addEtageDialog');
      dialog.showModal();
    }

    // Handle dialog form submission for adding Etage
    document.getElementById('addEtageDialog').addEventListener('submit', (e) => {
      e.preventDefault();

      const formData = new FormData(e.target);
      const etageName = formData.get('etageName');
      const defaultDatelimite = formData.get('defaultDatelimite');

      if (!etageName || etageName.trim() === "") {
        alert("Le nom de l'étage ne peut pas être vide.");
        return;
      }

      // Vérifiez les sélections actuelles
      const projectDropdown = document.getElementById('firstColumnDropdown');
      selectedFirstValue = projectDropdown.value.trim();

      if (!selectedFirstValue) {
        alert("Veuillez sélectionner un projet avant d'ajouter un étage.");
        return;
      }

      // Define the list of emetteurs as an array
      const emetteurs = [
        'ARCHI',
        'ASCENSORISTE',
        'CHARPENTIER',
        'METHODES',
        'OUVRAGES PROVISOIRES',
        'PLANS STRUCTURE AP',
        'RELEVE TOPOGRAPHIE'
      ];

      // Function to create new rows based on the emetteurs array
      function createNewRows(selectedProject, etageName, defaultDatelimite) {
        return emetteurs.map(emetteur => ({
          NomProjet: selectedProject,
          NomEtage: etageName,
          Emetteur: emetteur,
          Reference: '_',
          Indice: '_',
          Recu: '_',
          DescriptionObservations: 'EN ATTENTE',
          DateLimite: defaultDatelimite
        }));
      }

      // Create new rows using the emetteurs array
      const newRows = createNewRows(selectedFirstValue, etageName, defaultDatelimite);
      const actions = newRows.map(row => ['AddRecord', 'References', null, row]);

      // Ajoute la nouvelle ligne dans Grist
      grist.docApi.applyUserActions(actions)
        .then(() => {
          console.log("Nouvel étage ajouté :", newRows);

          newTable = true; // Set the flag to true to indicate a new table was added
          newTableName = etageName; // Store the name of the new table
          document.getElementById('addEtageDialog').close();
        })
        .catch((error) => {
          console.error("Erreur lors de l'ajout de l'étage :", error);
          alert("Erreur lors de l'ajout de l'étage.");
        });
    });

    // Function to insert a row below the specified row with the same "Emetteur" value
    function insertEmetteurRow(recordId) {
      const record = records.find(rec => rec.id === recordId);
      if (!record) {
        console.error("Record not found:", recordId);
        return;
      }

      const newRow = {
        NomProjet: record.NomProjet,
        NomEtage: record.NomEtage,
        Emetteur: record.Emetteur,
        Reference: '',
        Indice: '',
        Recu: '',
        DescriptionObservations: ''
      };

      grist.docApi.applyUserActions([
        ['AddRecord', 'References', null, newRow]
      ])
        .then(result => {
          const newRowId = result.retValues[0];
          console.log('New Row ID:', newRowId);
        })
        .catch(error => {
          console.error("Error inserting row:", error);
          alert("Error inserting row.");
        });
    }

    // Fonction pour ajouter une nouvelle ligne dans Grist
    function addRowToGrist() {
      if (!selectedFirstValue || !selectedSecondValue) {
        alert("Veuillez sélectionner un projet et un tableau.");
        return;
      }

      // Trouve la valeur la plus élevée d'ID_Ligne dans records
      const maxIdLigne = records.reduce((max, record) => {
        const idLigne = parseInt(record.ID_Ligne, 10);
        return idLigne > max ? idLigne : max;
      }, 0);

      // Définit une nouvelle valeur pour ID_Ligne en l'incrémentant de 1
      const newIdLigne = maxIdLigne + 1;

      // Création de la nouvelle ligne avec la valeur de ID_Ligne
      const newRow = {
        NomProjet: selectedFirstValue,
        NomEtage: selectedSecondValue,
        Emetteur: '',
        Reference: '',
        Indice: '',
        Recu: '',
        DescriptionObservations: '',
        ID_Ligne: newIdLigne.toString() // Convertit en string pour s'aligner avec les autres valeurs
      };

      // Envoie la requête pour ajouter la nouvelle ligne dans Grist
      grist.docApi.applyUserActions([
        ['AddRecord', 'References', null, newRow]  // Utilise null pour l'ID, Grist s'en chargera
      ])
        .then(() => {
          console.log("Nouvelle ligne ajoutée :", newRow);
          // Actualise les données pour inclure la nouvelle ligne ajoutée
          records.push(newRow); // Mise à jour locale
          populateTable(); // Actualise l'affichage du tableau HTML
        })
        .catch(error => {
          console.error("Erreur lors de l'ajout de la ligne :", error);
          alert("Erreur lors de l'ajout de la ligne.");
        });
    }

    // Écouteur d'événement pour le bouton d'ajout
    document.getElementById('addProjectButton').addEventListener('click', () => {
      document.getElementById('addProjectDialog').showModal();
    });

    // Handle project dialog form submission
    document.getElementById('addProjectDialog').addEventListener('submit', (e) => {
      e.preventDefault();
      const formData = new FormData(e.target);
      const projectName = formData.get('projectName');

      if (!projectName) {
        alert("Le nom du projet est requis.");
        return;
      }

      // Add the new project to Grist
      grist.docApi.applyUserActions([
        ['AddRecord', 'References', null, { NomProjet: projectName }]
      ])
        .then(() => {
          // Refresh the project dropdown
          const uniqueFirstColumnValues = [...new Set(records.map(record => record.NomProjet))];
          populateFirstColumnDropdown(uniqueFirstColumnValues);

          // Close the dialog
          document.getElementById('addProjectDialog').close();
        })
        .catch(error => {
          console.error("Erreur lors de l'ajout du projet :", error);
          alert("Erreur lors de l'ajout du projet.");
        });
    });

    function getCurrentSelections(isAddTableAction = false) {
      const projectDropdown = document.getElementById('firstColumnDropdown');
      const tableDropdown = document.getElementById('secondColumnListbox');

      const selectedProject = projectDropdown.value.trim();
      const selectedTable = tableDropdown.value.trim();

      if (!selectedProject || !selectedTable) {
        return null; // Retourne null si les sélections sont invalides
      }

      return { selectedProject, selectedTable };
    }

    // Fonction de sauvegarde mise à jour
    async function saveChanges() {
      // Obtenez les sélections actuelles
      const selections = getCurrentSelections();
      if (!selections) return; // Interrompt la fonction si les sélections sont invalides

      const { selectedProject, selectedTable } = selections;

      console.log(`Sauvegarde en cours pour le tableau "${selectedTable}" du projet "${selectedProject}".`);

      // Récupère les lignes du tableau HTML
      const tableBody = document.getElementById('tableBody');
      const rows = tableBody.getElementsByTagName('tr');

      const columnMap = ['Emetteur', 'Reference', 'Indice', 'Recu', 'DescriptionObservations'];
      const updates = [];

      for (const row of rows) {
        const cells = row.getElementsByTagName('td');
        const rowId = cells[0].textContent.trim(); // ID_Ligne

        // Recherche la ligne correspondante dans `records`
        const record = records.find(
          (rec) =>
            rec.ID_Ligne === rowId &&
            rec.NomProjet === selectedProject &&
            rec.NomEtage === selectedTable
        );

        if (!record) {
          console.warn(`Ligne introuvable pour ID_Ligne = ${rowId}, Projet = ${selectedProject}, Tableau = ${selectedTable}`);
          continue;
        }

        const updatedFields = {};
        let hasChanges = false;

        // Compare chaque champ
        for (let i = 1; i < cells.length; i++) {
          const fieldName = columnMap[i - 1];
          const cellValue = cells[i].textContent.trim();

          if (record[fieldName] !== cellValue) {
            updatedFields[fieldName] = cellValue;
            hasChanges = true;
          }
        }

        if (hasChanges) {
          updates.push(['UpdateRecord', 'Fusion', Number(rowId), updatedFields]);
        }
      }

      if (updates.length > 0) {
        try {
          await grist.docApi.applyUserActions(updates);
          console.log("Modifications sauvegardées avec succès :", updates);
          alert("Les modifications ont été sauvegardées.");
        } catch (error) {
          console.error("Erreur lors de la sauvegarde :", error);
          alert("Erreur lors de la sauvegarde.");
        }
      } else {
        alert("Aucune modification détectée pour la sauvegarde.");
      }
    }

    // Fonction pour ajouter une nouvelle ligne dans Grist avec le nom de fichier dans "Reference"
    function addRowWithFileName(fileName) {
      if (!selectedFirstValue || !selectedSecondValue) {
        alert("Veuillez sélectionner un projet et un tableau.");
        return;
      }

      // Enlève l'extension du fichier (partie après le dernier point)
      const fileNameWithoutExtension = fileName.split('.').slice(0, -1).join('.');

      // Trouve la valeur la plus élevée d'ID_Ligne dans records
      const maxIdLigne = records.reduce((max, record) => {
        const idLigne = parseInt(record.ID_Ligne, 10);
        return idLigne > max ? idLigne : max;
      }, 0);

      // Définit une nouvelle valeur pour ID_Ligne en l'incrémentant de 1
      const newIdLigne = maxIdLigne + 1;

      // Création de la nouvelle ligne avec la valeur de ID_Ligne et le nom du fichier sans extension pour "Reference"
      const newRow = {
        NomProjet: selectedFirstValue,
        NomEtage: selectedSecondValue,
        Emetteur: '',
        Reference: fileNameWithoutExtension, // Nom du fichier sans extension
        Indice: '',
        Recu: '',
        DescriptionObservations: '',
        ID_Ligne: newIdLigne.toString() // Convertit en string pour s'aligner avec les autres valeurs
      };

      // Envoie la requête pour ajouter la nouvelle ligne dans Grist
      grist.docApi.applyUserActions([
        ['AddRecord', 'Fusion', null, newRow]
      ])
        .then(() => {
          console.log("Nouvelle ligne ajoutée avec le fichier :", newRow);
          // Actualise les données pour inclure la nouvelle ligne ajoutée
          records.push(newRow); // Mise à jour locale
          populateTable(); // Actualise l'affichage du tableau HTML
        })
        .catch(error => {
          console.error("Erreur lors de l'ajout de la ligne avec le fichier :", error);
          alert("Erreur lors de l'ajout de la ligne.");
        });
    }

    // Gère l'événement de sélection de fichiers
    document.getElementById('fileInput').addEventListener('change', (event) => {
      const files = event.target.files;
      if (files.length > 0) {
        Array.from(files).forEach(file => {
          addRowWithFileName(file.name); // Ajoute une ligne pour chaque fichier sélectionné
        });
      }
    });

  </script>
</body>

</html>